<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆå­¦æ ¡æ•™æç‰ˆï¼‰</title>
<!-- 1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµ / HTTPS å‰æï¼ˆãƒã‚¤ã‚¯æ¨©é™ç”¨ï¼‰ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
<style>
  :root{
    --ink:#0d2b66;        /* æ–‡å­— */
    --grid:#cfe2ff;       /* ã‚°ãƒªãƒƒãƒ‰ */
    --axis:#5b8bd9;       /* è»¸è‰² */
    --wave:#0066cc;       /* æ³¢å½¢ */
    --bg:#ffffff;         /* èƒŒæ™¯ */
    --panel:#f5f9ff;      /* ãƒ‘ãƒãƒ« */
    --muted:#5f6b7a;      /* è£œåŠ©æ–‡å­— */
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;color:var(--ink);background:var(--bg)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel);border-bottom:1px solid #e6eefc}
  h1{font-size:16px;margin:0;font-weight:700;color:var(--ink)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .group{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:#fff;border:1px solid #e6eefc;border-radius:10px;padding:8px 10px}
  .group label{font-size:12px;color:var(--muted);margin-right:4px}
  button{appearance:none;border:1px solid #cfe0ff;background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer;min-width:44px}
  button:hover{opacity:.95}
  button.primary{background:#e8f1ff;border-color:#b9d1ff}
  button.danger{background:#fff0f0;border-color:#ffc0c0}
  .small{font-size:12px;padding:6px 10px}
  .status{font-size:12px;color:var(--muted)}
  main{padding:10px 14px}
  canvas{width:100%;height:300px;display:block;background:#fff;border:1px solid #e6eefc;border-radius:12px;box-shadow:0 1px 0 rgba(13,43,102,.04) inset}
  /* ãƒ—ãƒªã‚»ãƒƒãƒˆè‰²ï¼ˆãƒ‰ã€œãƒ‰ï¼‰ï¼šè¦–è¦šçš„ã«éŸ³ã®é•ã„ã‚’ç¤ºã™ */
  .note-do{background:#ffe3e3;border-color:#ffc2c2}
  .note-re{background:#fff1cf;border-color:#ffd48a}
  .note-mi{background:#f5ffd2;border-color:#dff28a}
  .note-fa{background:#e0ffe8;border-color:#b7f4c4}
  .note-so{background:#dff5ff;border-color:#bfe6ff}
  .note-la{background:#e9e0ff;border-color:#cdbbff}
  .note-si{background:#ffe0fa;border-color:#ffc2f0}
  .note-do-hi{background:#e8e8e8;border-color:#d0d0d0}
  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
  .slider{appearance:none;width:180px;height:6px;border-radius:999px;background:#e6eefc;outline:none}
  .slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#5b8bd9;border:1px solid #3e6fc2}
  .value{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
  <header>
    <h1>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—</h1>
    <div class="row">
      <!-- ãƒã‚¤ã‚¯ -->
      <div class="group" id="micGroup">
        <label>ãƒã‚¤ã‚¯</label>
        <button id="micStart" class="primary">â–¶ é–‹å§‹</button>
        <button id="micStop"  class="danger">â–  åœæ­¢</button>
      </div>
      
      <!-- ç™ºæŒ¯å™¨ï¼šå†ç”Ÿ/åœæ­¢ -->
      <div class="group" id="oscGroup">
        <label>ç™ºæŒ¯å™¨ï¼ˆæ­£å¼¦æ³¢ï¼‰</label>
        <button id="toneStart" class="primary">â–¶ ç™ºæŒ¯</button>
        <button id="toneStop"  class="danger">â–  åœæ­¢</button>
      </div>

      <!-- éŸ³é‡ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ + æ•°å€¤%ï¼‰ -->
      <div class="group" id="volGroup">
        <label>éŸ³é‡</label>
        <input id="volSlider" type="range" class="slider" min="0" max="100" step="1" value="0" aria-label="éŸ³é‡(%)">
        <span class="value" id="volLabel">0%</span>
      </div>

      <!-- ç”»åƒä¿å­˜ã ã‘æ®‹ã™ï¼ˆãƒ•ãƒªãƒ¼ã‚ºåˆ‡æ›¿ã¯ç„¡ã—ï¼‰ -->
      <div class="group" id="saveGroup">
        <label>æ³¢å½¢</label>
        <button id="saveBtn" class="small">ğŸ“¸ ç”»åƒä¿å­˜</button>
      </div>
    </div>
  </header>

  <!-- å‘¨æ³¢æ•°ãƒ—ãƒªã‚»ãƒƒãƒˆï¼šã‚¢ãƒ«ãƒˆãƒªã‚³ãƒ¼ãƒ€ãƒ¼ï¼ˆFç®¡ï¼‰ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰ / ãƒ©ãƒ™ãƒ«ã¯ä»®åã®ã¿ -->
  <main>
    <div class="group" id="presetGroup">
      <label>ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¢ãƒ«ãƒˆï¼šãƒ‰=F4ï¼‰</label>
      <div class="row">
        <button class="hzBtn note-do"    data-hz="349.23">ãƒ‰</button>
        <button class="hzBtn note-re"    data-hz="392.00">ãƒ¬</button>
        <button class="hzBtn note-mi"    data-hz="440.00">ãƒŸ</button>
        <button class="hzBtn note-fa"    data-hz="466.16">ãƒ•ã‚¡</button>
        <button class="hzBtn note-so"    data-hz="523.25">ã‚½</button>
        <button class="hzBtn note-la"    data-hz="587.33">ãƒ©</button>
        <button class="hzBtn note-si"    data-hz="659.25">ã‚·</button>
        <button class="hzBtn note-do-hi" data-hz="698.46">ãƒ‰</button>
      </div>
    </div>

    <div class="status" id="statusLine">
      ãƒã‚¤ã‚¯éŸ³é‡ dBFS: â€”.â€” dB
    </div>

    <canvas id="scope" width="600" height="300"></canvas>
  </main>

<script>
(() => {
  // ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåŸºç›¤ =====
  let audioCtx;
  let osc;                 // æ­£å¼¦æ³¢ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿
  let outGain;             // ç™ºæŒ¯å™¨ã®å‡ºåŠ›ã‚²ã‚¤ãƒ³ï¼ˆ0..1ï¼‰
  let master;              // å°†æ¥æ‹¡å¼µç”¨
  let micStream, micSrc, hpf, analyser;

  // æç”»
  const canvas = document.getElementById('scope');
  const ctx2d  = canvas.getContext('2d');

  // UI
  const micStartBtn = document.getElementById('micStart');
  const micStopBtn  = document.getElementById('micStop');
  const toneStartBtn= document.getElementById('toneStart');
  const toneStopBtn = document.getElementById('toneStop');
  const volSlider   = document.getElementById('volSlider');
  const volLabel    = document.getElementById('volLabel');
  const presetBtns  = [...document.querySelectorAll('.hzBtn')];
  const saveBtn     = document.getElementById('saveBtn');
  const statusLine  = document.getElementById('statusLine');

  // çŠ¶æ…‹
  let currentHz = 440; // åˆæœŸ A4

  // dBFSè¡¨ç¤ºï¼ˆRMSå¹³æ»‘ï¼‰
  const smoothAlpha = 0.2; // Î±=0.2
  let smoothedDb = null;

  function ensureCtx(){
    if (!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      outGain  = audioCtx.createGain();
      outGain.gain.value = 0.0; // åˆæœŸã¯ç„¡éŸ³
      master = audioCtx.createGain();
      master.gain.value = 1.0;
      outGain.connect(master).connect(audioCtx.destination);
    }
  }

  // ===== ç™ºæŒ¯å™¨ï¼ˆæ­£å¼¦æ³¢ï¼‰ =====
  function ensureOsc(){
    ensureCtx();
    if (!osc){
      osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(currentHz, audioCtx.currentTime);
      osc.connect(outGain);
      osc.start();
    }
  }
  function startTone(){ ensureCtx(); ensureOsc(); }
  function stopTone(){ if (osc){ try{ osc.disconnect(); }catch(e){} osc = null; } }
  function setFrequency(hz){
    currentHz = hz;
    if (osc && audioCtx){ osc.frequency.setValueAtTime(hz, audioCtx.currentTime); }
  }
  function setVolumePct(pct){
    const p = Math.max(0, Math.min(100, pct|0));
    volSlider.value = String(p);
    volLabel.textContent = p + '%';
    if (outGain && audioCtx){
      outGain.gain.setValueAtTime(p/100, audioCtx.currentTime);
    }
  }

  // ===== ãƒã‚¤ã‚¯ & è§£æ =====
  async function startMic(){
    ensureCtx();
    if (!micStream){
      micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      micSrc = audioCtx.createMediaStreamSource(micStream);

      // HPF 5Hz ã§DC/ä½åŸŸãƒã‚¤ã‚ºé™¤å»
      hpf = audioCtx.createBiquadFilter();
      hpf.type = 'highpass';
      hpf.frequency.value = 5;

      // Analyserï¼ˆæ™‚é–“æ³¢å½¢ï¼‰
      analyser = audioCtx.createAnalyser();
      const targetSamples = Math.max(256, Math.round(audioCtx.sampleRate * 0.02)); // â‰ˆ20ms
      const pow2 = (n)=>Math.pow(2, Math.round(Math.log2(n)));
      analyser.fftSize = Math.min(32768, Math.max(512, pow2(targetSamples*2)));
      analyser.smoothingTimeConstant = 0.0;

      micSrc.connect(hpf).connect(analyser);
    }
  }
  function stopMic(){
    if (analyser){ try{ hpf.disconnect(); }catch(e){} }
    analyser = null; hpf = null;
    if (micSrc){ try{ micSrc.disconnect(); }catch(e){} micSrc = null; }
    if (micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
  }

  function calcDbfsFromTimeData(buf){
    let sum = 0; for (let i=0;i<buf.length;i++){ const v = buf[i]; sum += v*v; }
    const rms = Math.sqrt(sum / buf.length) || 0;
    const db = 20*Math.log10(rms + 1e-12); // -âˆå›é¿
    return db;
  }

  // ===== æç”» =====
  function resizeCanvasForDPR(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx2d.setTransform(dpr,0,0,dpr,0,0);
  }
  function drawGrid(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    ctx2d.clearRect(0,0,w,h);
    ctx2d.fillStyle = '#fff'; ctx2d.fillRect(0,0,w,h);
    ctx2d.strokeStyle = 'var(--grid)'; ctx2d.lineWidth = 1;
    const divs = 10;
    for (let i=0;i<=divs;i++){ // ç¸¦ç·š
      const x = (w/divs)*i; ctx2d.beginPath(); ctx2d.moveTo(x,0); ctx2d.lineTo(x,h); ctx2d.stroke();
    }
    for (let j=0;j<=divs;j++){ // æ¨ªç·š
      const y = (h/divs)*j; ctx2d.beginPath(); ctx2d.moveTo(0,y); ctx2d.lineTo(w,y); ctx2d.stroke();
    }
    // ä¸­å¤®ç·šï¼ˆã‚„ã‚„ä¸Šï¼‰
    const centerY = Math.round(h*0.48);
    ctx2d.strokeStyle = 'var(--axis)';
    ctx2d.beginPath(); ctx2d.moveTo(0, centerY + .5); ctx2d.lineTo(w, centerY + .5); ctx2d.stroke();
    // â€» æ™‚é–“è»¸ã®è¡¨è¨˜ã¯è¡¨ç¤ºã—ãªã„
  }
  function drawWave(timeData){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const centerY = Math.round(h*0.48);
    ctx2d.strokeStyle = 'var(--wave)'; ctx2d.lineWidth = 2; ctx2d.beginPath();
    const len = timeData.length;
    for (let i=0;i<len;i++){
      const t = i/(len-1), x = t*w; const v = timeData[i];
      const y = centerY - v * (h*0.40); // å›ºå®šã‚¹ã‚±ãƒ¼ãƒ«
      if (i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    }
    ctx2d.stroke();
  }
  function render(){
    resizeCanvasForDPR();
    drawGrid();
    if (analyser){
      const N = analyser.fftSize/2|0;
      const buf = new Float32Array(N);
      analyser.getFloatTimeDomainData(buf);
      const instDb = calcDbfsFromTimeData(buf);
      smoothedDb = (smoothedDb==null)? instDb : smoothAlpha*instDb + (1-smoothAlpha)*smoothedDb;
      statusLine.textContent = `ãƒã‚¤ã‚¯éŸ³é‡ dBFS: ${smoothedDb.toFixed(1)} dB`;
      drawWave(buf);
    }
    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆæŸã­ =====
  presetBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const hz = Number(btn.dataset.hz);
      if (!isNaN(hz)) setFrequency(hz);
    });
  });
  volSlider.addEventListener('input', ()=>{
    const p = Number(volSlider.value)||0; volLabel.textContent = p + '%';
    if (outGain && audioCtx){ outGain.gain.setValueAtTime(p/100, audioCtx.currentTime); }
  });

  // ãƒã‚¤ã‚¯
  micStartBtn.addEventListener('click', async ()=>{
    try{ await startMic(); }
    catch(err){ alert('ãƒã‚¤ã‚¯é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã¨HTTPSã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); console.error(err); }
  });
  micStopBtn.addEventListener('click', ()=>{ stopMic(); });

  // ç™ºæŒ¯å™¨
  toneStartBtn.addEventListener('click', ()=>{ startTone(); });
  toneStopBtn .addEventListener('click', ()=>{ stopTone();  });

  // ç”»åƒä¿å­˜ï¼ˆãƒ•ãƒªãƒ¼ã‚ºæ©Ÿèƒ½ã¯è¦æ±‚ã«ã‚ˆã‚Šæœªå®Ÿè£…ï¼‰
  saveBtn.addEventListener('click', ()=>{
    const tmp = document.createElement('canvas');
    tmp.width = canvas.clientWidth; tmp.height = canvas.clientHeight;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(canvas, 0,0, tmp.width, tmp.height);
    const url = tmp.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url;
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.download = `scope_${ts}.png`; a.click();
  });

  // åˆæœŸçŠ¶æ…‹
  setFrequency(440.00); // A4
  setVolumePct(0);      // ç„¡éŸ³
})();
</script>
</body>
</html>

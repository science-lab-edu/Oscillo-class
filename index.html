<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ— ï¼ˆç™ºæŒ¯å™¨ã¤ãï¼‰</title>
<!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«è‡ªèº«ä»¥å¤–ã®èª­ã¿è¾¼ã¿ã‚’ç¦æ­¢ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline';">
<style>
  :root { --bg:#0b0f14; --panel:#131a22; --text:#eaf2ff; --muted:#9db1cc; --accent:#4cc9f0; --ok:#6ee7a2; --warn:#ffcf6e; }
  * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic UI", sans-serif; }
  body { margin:0; background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh; }
  header { padding:12px 16px; background:var(--panel); border-bottom:1px solid #1c2633; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  header h1 { font-size:18px; margin:0 12px 0 0; white-space:nowrap; }
  .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, select, input[type="range"], input[type="number"] { font-size:16px; }
  button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:#233142; color:var(--text); }
  button.primary { background:var(--accent); color:#001018; font-weight:700; }
  button.good { background:var(--ok); color:#00220c; font-weight:700; }
  button.warn { background:var(--warn); color:#2a1800; font-weight:700; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .label { font-size:13px; color:var(--muted); margin-right:6px; }
  .stack { display:flex; align-items:center; gap:8px; padding:4px 8px; background:#0e141c; border-radius:8px; }
  main { flex:1; display:grid; grid-template-rows: 1fr auto; gap:8px; padding:10px; }
  #scopeWrap { position:relative; border:1px solid #1c2633; border-radius:10px; background:#0a1017; height: 340px; }
  canvas { width:100%; height:100%; display:block; }
  #overlay { position:absolute; inset:0; pointer-events:none; }
  .statusbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; padding:8px 10px; background:var(--panel); border-top:1px solid #1c2633; }
  .meter { width:140px; height:10px; background:#142130; border-radius:6px; overflow:hidden; position:relative; }
  .meter > div { height:100%; width:0%; background:var(--ok); transition:width .05s linear; }
  .help { margin-left:auto; font-size:14px; color:var(--muted); }
  a { color: var(--accent); }
  /* ç™ºæŒ¯å™¨ãƒ‘ãƒãƒ« */
  .gen { padding:10px 16px; background:#0e141c; border-top:1px solid #1c2633; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .gen h2 { font-size:16px; margin:0 8px 0 0; }
  .gen .group { display:flex; align-items:center; gap:8px; background:#0b121a; padding:6px 8px; border-radius:8px; }
  .split { height:1px; width:100%; background:#152334; margin:8px 0; }
</style>
</head>
<body>
  <header>
    <h1>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ— v2</h1>
    <div class="controls">
      <button id="startBtn" class="primary">â–¶ ãƒã‚¤ã‚¯é–‹å§‹</button>
      <button id="stopBtn" class="warn" disabled>â–  åœæ­¢</button>
      <button id="freezeBtn">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="shotBtn">ğŸ“¸ ç”»åƒä¿å­˜</button>
      <div class="stack" aria-label="æ„Ÿåº¦">
        <span class="label">æ„Ÿåº¦ï¼ˆå¤§ãã•ï¼‰</span>
        <input id="gain" type="range" min="0.2" max="8" value="1.5" step="0.1" />
      </div>
      <div class="stack" aria-label="æ™‚é–“è»¸">
        <span class="label">æ™‚é–“è»¸</span>
        <select id="timebase">
          <option value="0.5">0.5 ms/div</option>
          <option value="1">1 ms/div</option>
          <option value="2" selected>2 ms/div</option>
          <option value="5">5 ms/div</option>
          <option value="10">10 ms/div</option>
          <option value="20">20 ms/div</option>
          <option value="50">50 ms/div</option>
        </select>
      </div>
      <div class="stack" aria-label="ãƒˆãƒªã‚¬">
        <span class="label">ãƒˆãƒªã‚¬</span>
        <select id="triggerMode" title="æ³¢å½¢ã‚’å®‰å®šè¡¨ç¤ºï¼ˆã‚¼ãƒ­ã‚¯ãƒ­ã‚¹æ¤œå‡ºï¼‰">
          <option value="free" selected>ãƒ•ãƒªãƒ¼</option>
          <option value="rise">ç«‹ä¸Šã‚Š</option>
          <option value="fall">ç«‹ä¸‹ã‚Š</option>
        </select>
        <span class="label">ã—ãã„å€¤</span>
        <input id="triggerLevel" type="range" min="-1" max="1" value="0" step="0.02" />
      </div>
    </div>
  </header>

  <!-- ç™ºæŒ¯å™¨ï¼ˆãƒˆãƒ¼ãƒ³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ï¼‰ -->
  <section class="gen" aria-label="å‘¨æ³¢æ•°ç™ºä¿¡ã‚·ã‚¹ãƒ†ãƒ ">
    <h2>ğŸ”Š ç™ºæŒ¯å™¨ï¼ˆæŒ‡å®šå‘¨æ³¢æ•°ã®éŸ³ã‚’å‡ºã™ï¼‰</h2>
    <div class="group">
      <span class="label">å‘¨æ³¢æ•°</span>
      <input id="freqNum" type="number" min="20" max="4000" step="1" value="440" style="width:96px;" />
      <input id="freqRange" type="range" min="20" max="4000" step="1" value="440" style="width:220px;" />
      <span class="label">Hz</span>
    </div>
    <div class="group">
      <span class="label">æ³¢å½¢</span>
      <select id="wave">
        <option value="sine" selected>æ­£å¼¦æ³¢</option>
        <option value="square">çŸ©å½¢æ³¢</option>
        <option value="sawtooth">ã®ã“ãã‚Šæ³¢</option>
        <option value="triangle">ä¸‰è§’æ³¢</option>
      </select>
    </div>
    <div class="group">
      <span class="label">éŸ³é‡</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.1" />
      <button id="muteBtn">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
    </div>
    <div class="group">
      <button id="toneStart" class="good">â–¶ ç™ºæŒ¯é–‹å§‹</button>
      <button id="toneStop" class="warn" disabled>â–  ç™ºæŒ¯åœæ­¢</button>
    </div>
    <div class="help">å®‰å…¨ã®ãŸã‚ã€éŸ³é‡ã¯å°ã•ã‚(0.1)ã‹ã‚‰ã‚†ã£ãã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ä½¿ç”¨æ™‚ã¯ç‰¹ã«æ³¨æ„ã€‚</div>
  </section>

  <main>
    <div id="scopeWrap" aria-label="ã‚ªã‚·ãƒ­ç”»é¢">
      <canvas id="scope" width="1200" height="500"></canvas>
      <canvas id="overlay" width="1200" height="500" aria-hidden="true"></canvas>
    </div>
    <div class="statusbar">
      <div><strong>ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æ³¢æ•°:</strong> <span id="sr">-</span> Hz</div>
      <div><strong>éŸ³é‡:</strong> <span id="db">-</span> dBFS</div>
      <div class="meter" aria-label="éŸ³é‡ãƒ¡ãƒ¼ã‚¿ãƒ¼"><div id="meterFill"></div></div>
      <div><strong>ä¸»å‘¨æ³¢æ•°:</strong> <span id="freq">-</span> Hz</div>
      <div class="help">ä½¿ã„æ–¹: ãƒã‚¤ã‚¯â–¶ã§æ³¢å½¢ã‚’è¦‹ã‚‹ / ç™ºæŒ¯å™¨â–¶ã§æŒ‡å®šå‘¨æ³¢æ•°ã‚’å†ç”Ÿã€‚ãƒˆãƒªã‚¬=ç«‹ä¸Šã‚Šã«ã™ã‚‹ã¨æ­£å¼¦æ³¢ãŒå®‰å®šã—ã¾ã™ã€‚</div>
    </div>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const startBtn = $('startBtn'), stopBtn = $('stopBtn'), freezeBtn = $('freezeBtn'), shotBtn = $('shotBtn');
  const gainEl = $('gain'), timebaseEl = $('timebase'), trigModeEl = $('triggerMode'), trigLvlEl = $('triggerLevel');
  const srEl = $('sr'), dbEl = $('db'), meterFill = $('meterFill');
  const canvas = $('scope'), ctx = canvas.getContext('2d');
  const ov = $('overlay'), octx = ov.getContext('2d');
  const freqEl = $('freq');

  // ç™ºæŒ¯å™¨UI
  const freqNum = $('freqNum'), freqRange = $('freqRange');
  const waveSel = $('wave'), volEl = $('vol');
  const muteBtn = $('muteBtn'), toneStart = $('toneStart'), toneStop = $('toneStop');

  let audioCtx, analyser, srcNode, micStream;
  let running = false, frozen = false;
  let gain = parseFloat(gainEl.value);
  let triggerMode = trigModeEl.value; // 'free' | 'rise' | 'fall'
  let triggerLevel = parseFloat(trigLvlEl.value);
  let fftSize = 4096; // å¤§ãã‚ã®ãƒãƒƒãƒ•ã‚¡ã§ãªã‚ã‚‰ã‹ã«
  let sampleRate = 48000;

  // ç™ºæŒ¯å™¨
  let osc = null, outGain = null, isMuted = false, targetVol = parseFloat(volEl.value);

  function drawGrid() {
    const w = canvas.width, h = canvas.height;
    octx.clearRect(0,0,w,h);
    // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
    octx.strokeStyle = '#122033';
    octx.lineWidth = 1;
    const divs = 10;
    for (let i = 0; i <= divs; i++) {
      const x = Math.round(i * w / divs) + 0.5;
      const y = Math.round(i * h / divs) + 0.5;
      octx.beginPath(); octx.moveTo(x, 0); octx.lineTo(x, h); octx.stroke();
      octx.beginPath(); octx.moveTo(0, y); octx.lineTo(w, y); octx.stroke();
    }
    // ä¸­å¿ƒç·š
    octx.strokeStyle = '#1e3a5c';
    octx.lineWidth = 1.5;
    octx.beginPath(); octx.moveTo(0, h/2+0.5); octx.lineTo(w, h/2+0.5); octx.stroke();

    // ç›®ç››ãƒ†ã‚­ã‚¹ãƒˆ
    octx.fillStyle = '#89a5c6';
    octx.font = '12px system-ui, sans-serif';
    const msPerDiv = parseFloat(timebaseEl.value);
    octx.fillText(`${msPerDiv} ms/div`, 8, 16);
    octx.fillText(`æ„Ÿåº¦Ã—${gain.toFixed(1)}`, 8, 32);
    octx.fillText(`ãƒˆãƒªã‚¬: ${triggerMode}${triggerMode==='free'?'':' @ '+triggerLevel.toFixed(2)}`, 8, 48);
  }

  function rmsDbFS(buf) {
    let sum=0;
    for (let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum / buf.length) || 1e-12;
    return 20*Math.log10(rms);
  }

  function findTriggerIndex(samples, level, mode) {
    for (let i = 1; i < samples.length; i++) {
      const prev = samples[i-1], cur = samples[i];
      if (mode === 'rise' && prev < level && cur >= level) return i;
      if (mode === 'fall' && prev > level && cur <= level) return i;
    }
    return -1;
  }

  function updateUIState() {
    startBtn.disabled = running;
    stopBtn.disabled = !running;
    freezeBtn.textContent = frozen ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
    toneStart.disabled = !!osc; // å†ç”Ÿä¸­ã¯é–‹å§‹ã‚’ç„¡åŠ¹
    toneStop.disabled = !osc;
    muteBtn.textContent = isMuted ? 'ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ';
  }

  function drawLoop() {
    if (!running) return;
    if (frozen) { requestAnimationFrame(drawLoop); return; }

    const w = canvas.width, h = canvas.height;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);

    // éŸ³é‡è¡¨ç¤º
    const db = rmsDbFS(buf);
    dbEl.textContent = db.toFixed(1);
    const norm = Math.min(1, Math.max(0, (db + 60) / 50)); // -60dBã€œ-10dBã‚’0ã€œ1ã«
    meterFill.style.width = (norm*100).toFixed(0) + '%';

    ctx.clearRect(0,0,w,h);

    // æ™‚é–“è»¸è¨ˆç®—
    const msPerDiv = parseFloat(timebaseEl.value);
    const totalMs = msPerDiv * 10; // 10 division å¹…
    const samplesNeeded = Math.max(512, Math.min(buf.length, Math.floor(sampleRate * (totalMs/1000))));
    let startIndex = buf.length - samplesNeeded;

    // ãƒˆãƒªã‚¬å‡¦ç†ï¼ˆä»»æ„ï¼‰
    if (triggerMode !== 'free') {
      const search = buf.subarray(buf.length - samplesNeeded - 2048);
      const idx = findTriggerIndex(search, triggerLevel, triggerMode);
      if (idx !== -1) {
        const offset = Math.max(0, (search.length - samplesNeeded) + idx);
        startIndex = Math.max(0, buf.length - search.length + offset);
      }
    }

    // æ³¢å½¢æç”»
    ctx.strokeStyle = '#4cc9f0';
    ctx.lineWidth = 2;
    ctx.beginPath();
    const step = samplesNeeded / w; // 1pxã‚ãŸã‚Šã®ã‚µãƒ³ãƒ—ãƒ«æ•°
    for (let i = 0; i < w; i++) {
      const di = Math.floor(startIndex + i*step);
      const v = (buf[di] || 0) * gain;
      const y = h/2 - v * (h*0.4);
      if (i===0) ctx.moveTo(0, y); else ctx.lineTo(i, y);
    }
    ctx.stroke();

    // ===== å‘¨æ³¢æ•°è§£æï¼ˆä¸»ãƒ”ãƒ¼ã‚¯ï¼‰ =====
    const freqBins = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(freqBins);
    let maxI = 0, maxV = -1;
    for (let i = 1; i < freqBins.length-1; i++) {
      if (freqBins[i] > maxV) { maxV = freqBins[i]; maxI = i; }
    }
    const y0 = freqBins[maxI-1] || 0, y1 = freqBins[maxI] || 0, y2 = freqBins[maxI+1] || 0;
    const denom = (y0 - 2*y1 + y2) || 1;
    const delta = (y0 - y2) / (2*denom);
    const preciseIndex = maxI + delta;
    const binHz = sampleRate / analyser.fftSize;
    const freq = Math.max(0, preciseIndex * binHz);
    freqEl.textContent = freq.toFixed(1);

    requestAnimationFrame(drawLoop);
  }

  async function start() {
    if (running) return;
    try {
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, latency: 0 },
        video:false
      });
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      sampleRate = audioCtx.sampleRate;
      srEl.textContent = sampleRate.toFixed(0);

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = fftSize;
      analyser.smoothingTimeConstant = 0.02;

      srcNode = audioCtx.createMediaStreamSource(micStream);
      srcNode.connect(analyser);

      // ç™ºæŒ¯å™¨ã®å‡ºåŠ›ã‚‚å¯è¦–åŒ–ã«æ··ãœãŸã„å ´åˆã¯ã€ä¸‹ã®1è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
      // outGain && outGain.connect(analyser);

      running = true; frozen = false;
      updateUIState(); drawGrid(); drawLoop();
    } catch(err) {
      alert('ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ»HTTPSã§é–‹ã„ã¦ã„ã¾ã™ã‹ï¼Ÿ\nãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ã‚’ONã«ã—ã¾ã—ãŸã‹ï¼Ÿ\n\nè©³ç´°: ' + err.message);
      console.error(err);
    }
  }

  function stop() {
    running = false;
    if (srcNode) { try { srcNode.disconnect(); } catch{} }
    if (micStream) micStream.getTracks().forEach(t => t.stop());
    if (audioCtx) audioCtx.close();
    updateUIState();
  }

  function freeze() {
    if (!running) return;
    frozen = !frozen;
    updateUIState();
  }

  function savePng() {
    const w = canvas.width, h = canvas.height;
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(ov,0,0);
    tctx.drawImage(canvas,0,0);
    const a = document.createElement('a');
    a.download = 'waveform.png';
    a.href = tmp.toDataURL('image/png');
    a.click();
  }

  // é«˜DPIå¯¾å¿œã¨ãƒªã‚µã‚¤ã‚º
  function fitCanvas() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = $('scopeWrap').getBoundingClientRect();
    [canvas, ov].forEach(c => {
      c.width  = Math.floor(rect.width * dpr);
      c.height = Math.floor(Math.max(260, rect.height) * dpr);
      c.style.width = rect.width + 'px';
      c.style.height = Math.max(260, rect.height) + 'px';
      c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
    });
    drawGrid();
  }

  // ===== ç™ºæŒ¯å™¨ãƒ­ã‚¸ãƒƒã‚¯ =====
  function ensureCtx() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      sampleRate = audioCtx.sampleRate;
      srEl.textContent = sampleRate.toFixed(0);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = fftSize;
      analyser.smoothingTimeConstant = 0.02;
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å¯è¦–åŒ–ã¯ãƒã‚¤ã‚¯ç”±æ¥ã€‚ç™ºæŒ¯å™¨ã ã‘ä½¿ã†å ´åˆã¯ analyser ã‚’ä½¿ã‚ãªã„ã“ã¨ã‚‚OK
    }
  }

  function startTone() {
    ensureCtx();
    if (osc) return;
    osc = audioCtx.createOscillator();
    outGain = audioCtx.createGain();

    // å€¤ã®åæ˜ 
    const f = clampFreq(parseFloat(freqNum.value));
    osc.frequency.value = f;
    osc.type = waveSel.value;

    // ã‚½ãƒ•ãƒˆã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
    const now = audioCtx.currentTime;
    outGain.gain.cancelScheduledValues(now);
    outGain.gain.setValueAtTime(0.0001, now);
    outGain.gain.exponentialRampToValueAtTime(isMuted ? 0.0001 : Math.max(0.0001, targetVol), now + 0.05);

    osc.connect(outGain).connect(audioCtx.destination);

    // è¦³æ¸¬ã«æ··ãœãŸã„å ´åˆã¯ analyser ã«ã‚‚æ¥ç¶šï¼ˆãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã›ãšã«è¦–è¦šåŒ–ï¼‰
    // outGain.connect(analyser);

    osc.start();
    updateUIState();
  }

  function stopTone() {
    if (!osc) return;
    const now = audioCtx.currentTime;
    outGain.gain.cancelScheduledValues(now);
    outGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);
    setTimeout(() => {
      try { osc.stop(); } catch {}
      try { osc.disconnect(); outGain.disconnect(); } catch {}
      osc = null; outGain = null;
      updateUIState();
    }, 60);
  }

  function clampFreq(v) {
    if (!isFinite(v)) v = 440;
    return Math.min(4000, Math.max(20, v));
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', () => { stop(); });
  freezeBtn.addEventListener('click', freeze);
  shotBtn.addEventListener('click', savePng);

  gainEl.addEventListener('input', e => { gain = parseFloat(e.target.value); drawGrid(); });
  timebaseEl.addEventListener('change', drawGrid);
  trigModeEl.addEventListener('change', e => { triggerMode = e.target.value; drawGrid(); });
  trigLvlEl.addEventListener('input', e => { triggerLevel = parseFloat(e.target.value); drawGrid(); });

  window.addEventListener('resize', fitCanvas);
  window.addEventListener('keydown', (e) => {
    if (e.key === ' ') { e.preventDefault(); freeze(); }
    if (e.key.toLowerCase() === 's') savePng();
  });

  // ç™ºæŒ¯å™¨UIã‚¤ãƒ™ãƒ³ãƒˆ
  function syncFreqInputs(from, v) {
    const fv = clampFreq(v);
    freqNum.value = fv;
    freqRange.value = fv;
    if (osc) osc.frequency.setTargetAtTime(fv, audioCtx.currentTime, 0.01);
  }
  freqNum.addEventListener('input', e => syncFreqInputs('num', parseFloat(e.target.value)));
  freqRange.addEventListener('input', e => syncFreqInputs('range', parseFloat(e.target.value)));
  waveSel.addEventListener('change', () => { if (osc) osc.type = waveSel.value; });
  volEl.addEventListener('input', () => {
    targetVol = parseFloat(volEl.value);
    if (outGain && !isMuted) outGain.gain.setTargetAtTime(Math.max(0.0001, targetVol), audioCtx.currentTime, 0.02);
  });
  muteBtn.addEventListener('click', () => {
    isMuted = !isMuted;
    if (outGain) outGain.gain.setTargetAtTime(isMuted ? 0.0001 : Math.max(0.0001, targetVol), audioCtx.currentTime, 0.02);
    updateUIState();
  });
  toneStart.addEventListener('click', startTone);
  toneStop.addEventListener('click', stopTone);

  fitCanvas(); drawGrid();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆå­¦æ ¡æ•™æç‰ˆï¼‰</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
<style>
  :root{
    --ink:#0d2b66; --grid:#cfe2ff; --axis:#5b8bd9; --wave:#0066cc; --bg:#ffffff;
    --panel:#f5f9ff; --muted:#5f6b7a; --ok:#2aa876; --warn:#e67e22;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans","Yu Gothic UI",sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink)}
  header{border-bottom:2px solid #e6eefb;background:var(--panel)}
  .wrap{max-width:1080px;margin:0 auto;padding:10px 16px}
  h1{font-size:20px;margin:0 0 8px 0}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .group{background:#fff;border:1px solid #e6eefb;border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px}
  .label{font-size:13px;color:var(--muted)}
  button,select,input[type="range"],input[type="number"]{font-size:16px}
  button{padding:8px 12px;border-radius:8px;border:1px solid #c9daf8;background:#fff;color:var(--ink);cursor:pointer}
  button.primary{background:var(--axis);color:#fff;border-color:var(--axis);font-weight:700}
  button.good{background:var(--ok);color:#fff;border-color:var(--ok);font-weight:700}
  button.warn{background:var(--warn);color:#fff;border-color:var(--warn);font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  main{max-width:1080px;margin:6px auto 10px;padding:0 16px}
  #scopeWrap{border:2px solid #e6eefb;border-radius:12px;padding:6px;background:#fff}
  canvas{width:100%;height:100%;display:block}
  #scope{width:100%;height:300px}
  .status{display:flex;flex-wrap:wrap;gap:14px;align-items:center;margin:6px 0 0;color:var(--muted)}
  .note{margin-top:8px;font-size:14px;color:#233}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—</h1>
      <div class="controls">
        <div class="group">
          <span class="label">ãƒã‚¤ã‚¯</span>
          <button id="micStart" class="primary">â–¶ é–‹å§‹</button>
          <button id="micStop"  class="warn" disabled>â–  åœæ­¢</button>
        </div>
        <div class="group">
          <span class="label">æ³¢å½¢è¡¨ç¤º</span>
          <button id="freezeBtn">â¸ æ³¢å½¢ã‚’æ­¢ã‚ã‚‹</button>
          <button id="shotBtn">ğŸ“¸ ç”»åƒä¿å­˜</button>
        </div>
        <div class="group">
          <span class="label">ç™ºæŒ¯å™¨ï¼ˆæ­£å¼¦æ³¢ï¼‰</span>
          <button id="toneStart" class="good">â–¶ ç™ºæŒ¯</button>
          <button id="toneStop"  class="warn" disabled>â–  åœæ­¢</button>
          <span class="label">å‘¨æ³¢æ•°</span>
          <input id="freqNum" type="number" min="200" max="2000" step="1" value="440" style="width:92px">
          <input id="freqRange" type="range" min="200" max="2000" step="1" value="440" style="width:200px">
          <span class="label">éŸ³é‡</span>
          <input id="vol" type="range" min="0" max="100" step="1" value="10" style="width:140px">
          <span class="label" aria-live="polite"><b id="tonePct">10%</b></span>
        </div>
      </div>
      <div class="status">
        <div><b>æ™‚é–“è»¸:</b> 2 ms/divï¼ˆå›ºå®šï¼‰</div>
        <!-- dBFS â†’ dB è¡¨ç¤ºã«å¤‰æ›´ -->
        <div><b>ãƒã‚¤ã‚¯éŸ³é‡:</b> <span id="micDb">-</span> dB</div>
      </div>
    </div>
  </header>

  <main>
    <div id="scopeWrap" aria-label="ã‚ªã‚·ãƒ­ç”»é¢ï¼ˆä¸‹ï¼šæ™‚é–“ã€ä¸­å¤®ç·šï¼šæŒ¯å¹…0ï¼‰">
      <canvas id="scope" width="1000" height="320"></canvas>
    </div>
    <div class="note">
      ä½¿ã„æ–¹ï¼šâ‘ ã€Œâ–¶ é–‹å§‹ã€ã§ãƒã‚¤ã‚¯ã‚’ONã€‚â‘¡ã€Œâ–¶ ç™ºæŒ¯ã€ã§éŸ³ã‚’å‡ºã—ã¾ã™ã€‚å‘¨æ³¢æ•°ï¼ˆ200ã€œ2000Hzï¼‰ã‚„éŸ³é‡ã‚’å¤‰ãˆã‚‹ã¨ã€æ³¢ã®é–“éš”ã‚„é«˜ã•ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚â¸ã§æ³¢å½¢ã‚’æ­¢ã‚ã¦è¦³å¯Ÿã€ğŸ“¸ã§ç”»åƒä¿å­˜ãŒã§ãã¾ã™ã€‚
    </div>
  </main>

<script>
(()=> {
  const $ = id => document.getElementById(id);
  const micStart = $('micStart'), micStop = $('micStop'), freezeBtn = $('freezeBtn'), shotBtn = $('shotBtn');
  const scope = $('scope'), ctx = scope.getContext('2d');
  const micDbEl = $('micDb');
  const tonePctEl = $('tonePct');

  // ç™ºæŒ¯å™¨UI
  const toneStart = $('toneStart'), toneStop = $('toneStop');
  const freqNum = $('freqNum'), freqRange = $('freqRange'), volEl = $('vol');

  // Web Audio
  let audioCtx = null, analyser = null, micStream = null, micNode = null, hp = null;
  let running = false, frozen = false;
  const SAMPLE_TIME_MS = 2 * 10; // 20ms
  let sampleRate = 48000;

  // ç™ºæŒ¯å™¨
  let osc = null, outGain = null;
  let targetVol = 0.10; // 10%â†’0.10ï¼ˆç™ºæŒ¯å™¨å‡ºåŠ›ï¼…è¡¨ç¤ºã¯ã“ã‚Œã‚’ä½¿ç”¨ï¼‰
  const clampFreq = v => Math.min(2000, Math.max(200, Number(v)||440));

  // â”€â”€ æç”»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæœ€å°å¤‰æ›´ã§è¦æ±‚åæ˜ ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // è»¸ãƒ©ãƒ™ãƒ«ã‚’å¤–å´ã¸å‡ºã™ãŸã‚ã®ãƒãƒ¼ã‚¸ãƒ³
  const MARGIN_LEFT = 56;   // ç¸¦ãƒ©ãƒ™ãƒ«é ˜åŸŸ
  const MARGIN_BOTTOM = 28; // æ¨ªãƒ©ãƒ™ãƒ«é ˜åŸŸ
  // æ³¢å½¢ã‚’ã€Œã‚‚ã£ã¨ä¸Šã€ã« + è¦‹åˆ‡ã‚Œé˜²æ­¢ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
  const V_OFFSET_PX = 36;   // åŸºæº–ç·šã‚’ä¸Šã¸
  const TOP_PAD = 12;       // ä¸Šã®ä½™ç™½
  const BOTTOM_PAD = 18;    // ä¸‹ã®ä½™ç™½ï¼ˆæ¨ªè»¸ã¨ã®å¹²æ¸‰ã‚‚é¿ã‘ã‚‹ï¼‰
  // ãƒ—ãƒ­ãƒƒãƒˆé ˜åŸŸæƒ…å ±ï¼ˆdrawGridã§æ›´æ–° â†’ loopã§ä½¿ç”¨ï¼‰
  const plot = {x:0,y:0,w:0,h:0, mid:0, ampPx:0};

  // dBè¡¨ç¤ºã®å¹³æ»‘åŒ–
  let smoothedDb = -90;
  const DB_ALPHA = 0.2;

  function uiUpdate(){
    micStart.disabled = running;
    micStop.disabled  = !running;
    freezeBtn.textContent = frozen ? 'â–¶ å†é–‹' : 'â¸ æ³¢å½¢ã‚’æ­¢ã‚ã‚‹';
    toneStart.disabled = !!osc;
    toneStop.disabled  = !osc;
    tonePctEl.textContent = Math.round(targetVol*100) + '%';
  }

  async function startMic(){
    if (running) return;
    try{
      micStream = await navigator.mediaDevices.getUserMedia({
        audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false},
        video:false
      });
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      sampleRate = audioCtx.sampleRate;

      // ãƒã‚¤ãƒ‘ã‚¹ 5 Hzï¼ˆDCé™¤å»ï¼‰
      hp = audioCtx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 5;
      hp.Q.value = 0.707;

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 4096;
      analyser.smoothingTimeConstant = 0.0;

      micNode = audioCtx.createMediaStreamSource(micStream);
      micNode.connect(hp).connect(analyser);

      running = true; frozen = false;
      uiUpdate(); drawGrid(); loop();
    }catch(e){
      alert('ãƒã‚¤ã‚¯ã‚’ä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚HTTPSã§é–‹ãã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ã‚’ONã«ã—ã¦ãã ã•ã„ã€‚\nè©³ç´°: '+e.message);
      console.error(e);
    }
  }

  function stopMic(){
    running = false;
    if (micNode){ try{micNode.disconnect();}catch{} }
    if (hp){ try{hp.disconnect();}catch{} }
    if (micStream){ micStream.getTracks().forEach(t=>t.stop()); }
    if (audioCtx){ try{audioCtx.close();}catch{} }
    micNode = null; hp = null; micStream = null; audioCtx = null; analyser = null;
    uiUpdate(); drawGrid(true); micDbEl.textContent = '-';
  }

  function drawGrid(clearOnly){
    const w = scope.width, h = scope.height;
    ctx.clearRect(0,0,w,h);
    if (clearOnly) return;

    // èƒŒæ™¯
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,w,h);

    // ãƒ—ãƒ­ãƒƒãƒˆé ˜åŸŸã‚’è¨ˆç®—
    plot.x = MARGIN_LEFT;
    plot.y = 0;
    plot.w = w - MARGIN_LEFT;
    plot.h = h - MARGIN_BOTTOM;

    // ã‚°ãƒªãƒƒãƒ‰ï¼ˆ10ç­‰åˆ†ï¼‰â€»ãƒ—ãƒ­ãƒƒãƒˆå†…ã®ã¿
    ctx.strokeStyle = '#cfe2ff';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0;i<=10;i++){
      const x = Math.round(plot.x + (plot.w*i/10)) + 0.5;
      const y = Math.round(plot.y + (plot.h*i/10)) + 0.5;
      ctx.moveTo(x, plot.y); ctx.lineTo(x, plot.y+plot.h);
      ctx.moveTo(plot.x, y); ctx.lineTo(plot.x+plot.w, y);
    }
    ctx.stroke();

    // æ³¢å½¢ä¸­å¤®ç·šï¼ˆæŒ¯å¹…0ï¼‰â€¦ã•ã‚‰ã«ä¸Šã¸
    plot.mid = plot.y + (plot.h/2) - V_OFFSET_PX;

    // è¦‹åˆ‡ã‚Œé˜²æ­¢ã®å®ŸåŠ¹æŒ¯å¹…ï¼ˆä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° ã‹ã¤ 5%ãƒ˜ãƒƒãƒ‰ãƒ«ãƒ¼ãƒ ï¼‰
    plot.ampPx = ((plot.h/2) - TOP_PAD - BOTTOM_PAD) * 0.95;

    ctx.strokeStyle = '#5b8bd9';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(plot.x, plot.mid + 0.5);
    ctx.lineTo(plot.x + plot.w, plot.mid + 0.5);
    ctx.stroke();

    // è»¸ãƒ©ãƒ™ãƒ«ï¼ˆå¤–å´ï¼‰
    ctx.fillStyle = '#0d2b66';
    ctx.font = '14px system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('æ™‚é–“ï¼ˆ2 ms/div å›ºå®šï¼‰', plot.x + plot.w/2, h - 8);

    ctx.save();
    ctx.translate(16, plot.y + plot.h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = 'center';
    ctx.fillText('æŒ¯å¹…ï¼ˆæ³¢ã®é«˜ã•ï¼‰', 0, 0);
    ctx.restore();
  }

  function rmsDbFS(buf){
    let sum=0;
    for(let i=0;i<buf.length;i++){ const v=buf[i]; sum += v*v; }
    const rms = Math.sqrt(sum/Math.max(1,buf.length)) || 1e-12;
    return 20*Math.log10(rms); // 0 dBFS = ãƒ•ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«
  }

  function loop(){
    if (!running) return;
    if (frozen){ requestAnimationFrame(loop); return; }

    const w = scope.width, h = scope.height;

    // ç´„20msåˆ†ã®ã‚µãƒ³ãƒ—ãƒ«
    const samplesNeeded = Math.max(512, Math.floor(sampleRate * (SAMPLE_TIME_MS/1000)));
    const buf = new Float32Array(Math.max(samplesNeeded, (analyser?.fftSize||4096)));
    analyser.getFloatTimeDomainData(buf);

    // dBï¼ˆæ•™è‚²ç”¨ã®ç›¸å¯¾dBè¡¨ç¤º 0ã€œ60dBï¼‰
    const instantDb = rmsDbFS(buf);                     // dBFSï¼ˆè² ï¼‰
    smoothedDb = DB_ALPHA*instantDb + (1-DB_ALPHA)*smoothedDb;
    const dbRel = Math.max(0, Math.min(60, smoothedDb + 60)); // -60..0 dBFS â†’ 0..60 dB
    micDbEl.textContent = dbRel.toFixed(1);

    // æç”»
    drawGrid();
    ctx.strokeStyle = '#0066cc';
    ctx.lineWidth = 2;
    ctx.beginPath();

    const start = Math.max(0, buf.length - samplesNeeded);
    const step = (samplesNeeded) / Math.max(1, plot.w); // ãƒ—ãƒ­ãƒƒãƒˆå¹…åŸºæº–
    for (let i=0;i<plot.w;i++){
      const di = Math.floor(start + i*step);
      const v = buf[di] || 0; // -1..1
      const x = plot.x + i;
      const y = plot.mid - v * plot.ampPx;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    requestAnimationFrame(loop);
  }

  // ç”»åƒä¿å­˜
  function savePng(){
    const tmp = document.createElement('canvas');
    tmp.width = scope.width; tmp.height = scope.height;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(scope,0,0);
    const a = document.createElement('a');
    a.download = 'waveform.png';
    a.href = tmp.toDataURL('image/png');
    a.click();
  }

  // ç™ºæŒ¯å™¨
  function ensureCtx(){
    if (!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
  }

  function startTone(){
    ensureCtx();
    if (osc) return;
    osc = audioCtx.createOscillator();
    osc.type = 'sine';
    outGain = audioCtx.createGain();

    const f = clampFreq(freqNum.value);
    osc.frequency.value = f;

    outGain.gain.setValueAtTime(Math.max(0.0001, targetVol), audioCtx.currentTime);
    osc.connect(outGain).connect(audioCtx.destination);
    osc.start();
    uiUpdate();
  }

  function stopTone(){
    if (!osc) return;
    try{
      const now=audioCtx.currentTime;
      outGain.gain.cancelScheduledValues(now);
      outGain.gain.setTargetAtTime(0.0001, now, 0.03);
      setTimeout(()=>{ try{osc.stop();}catch{} try{osc.disconnect(); outGain.disconnect();}catch{} osc=null; outGain=null; uiUpdate(); },60);
    }catch{}
  }

  function syncFreqInputs(v){
    const fv = clampFreq(v);
    freqNum.value = fv; freqRange.value = fv;
    if (osc) osc.frequency.setTargetAtTime(fv, audioCtx?.currentTime||0, 0.01); // A+B
  }

  // ãƒªã‚µã‚¤ã‚ºï¼šå†…éƒ¨è§£åƒåº¦ã®ã¿èª¿æ•´
  function fitCanvas(){
    const rect = scope.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    scope.width  = Math.floor(rect.width * dpr);
    scope.height = Math.floor(300 * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawGrid();
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  micStart.addEventListener('click', startMic);
  micStop.addEventListener('click', stopMic);
  freezeBtn.addEventListener('click', ()=>{ if(running){ frozen=!frozen; uiUpdate(); } });
  shotBtn.addEventListener('click', savePng);

  freqNum.addEventListener('input', e=> syncFreqInputs(e.target.value));
  freqRange.addEventListener('input', e=> syncFreqInputs(e.target.value));
  volEl.addEventListener('input', e=>{
    const p = Math.min(100, Math.max(0, Number(e.target.value)||0));
    targetVol = Math.max(0.0001, p/100);
    tonePctEl.textContent = p + '%';
    if (outGain) outGain.gain.setTargetAtTime(targetVol, audioCtx.currentTime, 0.02);
  });

  toneStart.addEventListener('click', startTone);
  toneStop .addEventListener('click', stopTone);

  window.addEventListener('resize', fitCanvas);
  window.addEventListener('keydown', e=>{
    if (e.key === ' ') { e.preventDefault(); if(running){ frozen=!frozen; uiUpdate(); } }
    if (e.key.toLowerCase() === 's') savePng();
  });

  fitCanvas(); drawGrid(true);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆå­¦æ ¡æ•™æç‰ˆï¼‰</title>
<!-- ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã®èª­ã¿è¾¼ã¿ã‚’ç¦æ­¢ï¼ˆè‡ªå·±å®Œçµï¼‰ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
<style>
  :root{
    --ink:#0d2b66;        /* æ–‡å­—/ç·š */
    --grid:#cfe2ff;       /* ã‚°ãƒªãƒƒãƒ‰ */
    --axis:#5b8bd9;       /* è»¸è‰² */
    --wave:#0066cc;       /* æ³¢å½¢è‰² */
    --bg:#ffffff;         /* èƒŒæ™¯ */
    --panel:#f5f9ff;      /* ãƒ‘ãƒãƒ« */
    --muted:#5f6b7a;      /* è£œåŠ©æ–‡å­— */
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;color:var(--ink);background:var(--bg)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel);border-bottom:1px solid #e6eefc}
  h1{font-size:16px;margin:0;font-weight:700;color:var(--ink)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .group{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:#fff;border:1px solid #e6eefc;border-radius:10px;padding:8px 10px}
  .group label{font-size:12px;color:var(--muted);margin-right:4px}
  button{appearance:none;border:1px solid #cfe0ff;background:#fff;border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer}
  button:hover{background:#f3f8ff}
  button.primary{background:#e8f1ff;border-color:#b9d1ff}
  button.danger{background:#fff0f0;border-color:#ffc0c0}
  button.small{font-size:12px;padding:4px 8px}
  .value{font-variant-numeric:tabular-nums}
  .status{font-size:12px;color:var(--muted)}
  main{padding:10px 14px}
  canvas{width:100%;height:300px;display:block;background:#fff;border:1px solid #e6eefc;border-radius:12px;box-shadow:0 1px 0 rgba(13,43,102,.04) inset}
  .help{padding:6px 14px;font-size:12px;color:var(--muted)}
  /* ä¸­å¤®ç·šã‚’ã‚„ã‚„ä¸Šã«è¦‹ã›ã‚‹ãŸã‚ã®ä½™ç™½æ„Ÿè¦šã¯æç”»å´ã§èª¿æ•´ */
</style>
</head>
<body>
  <header>
    <h1>ã‹ã‚“ãŸã‚“Webã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—</h1>
    <div class="row">
      <!-- ãƒã‚¤ã‚¯ -->
      <div class="group" id="micGroup">
        <label>ãƒã‚¤ã‚¯</label>
        <button id="micStart" class="primary">â–¶ é–‹å§‹</button>
        <button id="micStop"  class="danger">â–  åœæ­¢</button>
      </div>

      <!-- è¡¨ç¤ºï¼šãƒ•ãƒªãƒ¼ã‚ºï¼†ä¿å­˜ -->
      <div class="group" id="viewGroup">
        <label>æ³¢å½¢è¡¨ç¤º</label>
        <button id="freezeBtn">â¸ åœæ­¢</button>
        <button id="saveBtn" class="small">ğŸ“¸ ç”»åƒä¿å­˜</button>
      </div>

      <!-- ç™ºæŒ¯å™¨ï¼šå†ç”Ÿ/åœæ­¢ -->
      <div class="group" id="oscGroup">
        <label>ç™ºæŒ¯å™¨ï¼ˆæ­£å¼¦æ³¢ï¼‰</label>
        <button id="toneStart" class="primary">â–¶ ç™ºæŒ¯</button>
        <button id="toneStop"  class="danger">â–  åœæ­¢</button>
      </div>

      <!-- éŸ³é‡ãƒœã‚¿ãƒ³ç¾¤ï¼ˆï¼…ï¼‰ -->
      <div class="group" id="volGroup">
        <label>éŸ³é‡</label>
        <div class="row">
          <button class="volBtn small" data-pct="0">0%</button>
          <button class="volBtn small" data-pct="25">25%</button>
          <button class="volBtn small" data-pct="50">50%</button>
          <button class="volBtn small" data-pct="75">75%</button>
          <button class="volBtn small" data-pct="100">100%</button>
        </div>
        <span class="value" id="volLabel">å‡ºåŠ›: 0%</span>
      </div>
    </div>
  </header>

  <div class="help">Spaceï¼ãƒ•ãƒªãƒ¼ã‚ºåˆ‡æ›¿ / Sï¼ç”»åƒä¿å­˜ã€€ï½œã€€æ™‚é–“è»¸= 2 ms/divï¼ˆåˆè¨ˆ ~20 msï¼‰</div>

  <!-- å‘¨æ³¢æ•°ãƒ—ãƒªã‚»ãƒƒãƒˆï¼šã‚¢ãƒ«ãƒˆãƒªã‚³ãƒ¼ãƒ€ãƒ¼ï¼ˆFç®¡ï¼‰ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰ -->
  <main>
    <div class="group" id="presetGroup">
      <label>ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¢ãƒ«ãƒˆï¼šãƒ‰=F4ï¼‰</label>
      <div class="row">
        <button class="hzBtn" data-hz="349.23">ãƒ‰ F4 349.23Hz</button>
        <button class="hzBtn" data-hz="392.00">ãƒ¬ G4 392.00Hz</button>
        <button class="hzBtn" data-hz="440.00">ãƒŸ A4 440.00Hz</button>
        <button class="hzBtn" data-hz="466.16">ãƒ•ã‚¡ Bb4 466.16Hz</button>
        <button class="hzBtn" data-hz="523.25">ã‚½ C5 523.25Hz</button>
        <button class="hzBtn" data-hz="587.33">ãƒ© D5 587.33Hz</button>
        <button class="hzBtn" data-hz="659.25">ã‚· E5 659.25Hz</button>
        <button class="hzBtn" data-hz="698.46">ãƒ‰ F5 698.46Hz</button>
      </div>
      <span class="value" id="freqLabel">å‘¨æ³¢æ•°: â€”</span>
    </div>

    <div class="status" id="statusLine">
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šæ™‚é–“è»¸=2 ms/div å›ºå®šã€€|ã€€ãƒã‚¤ã‚¯éŸ³é‡ dBFS: â€”.â€” dB
    </div>

    <canvas id="scope" width="600" height="300"></canvas>
  </main>

<script>
(() => {
  // ==========
  // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåŸºç›¤
  // ==========
  let audioCtx;
  let osc;                 // Sine oscillator
  let outGain;             // å‡ºåŠ›ã‚²ã‚¤ãƒ³ï¼ˆç™ºæŒ¯å™¨å‡ºåŠ›ï¼…ã¯ã“ã®å€¤ã§ç®¡ç†ï¼‰
  let master;              // å°†æ¥ã®æ‹¡å¼µç”¨ï¼ˆA+Bãªã©ï¼‰
  let micStream, micSrc, hpf, analyser;

  // æç”»
  const canvas = document.getElementById('scope');
  const ctx2d  = canvas.getContext('2d');
  let frozen = false;

  // UI
  const micStartBtn = document.getElementById('micStart');
  const micStopBtn  = document.getElementById('micStop');
  const toneStartBtn= document.getElementById('toneStart');
  const toneStopBtn = document.getElementById('toneStop');
  const volLabel    = document.getElementById('volLabel');
  const freqLabel   = document.getElementById('freqLabel');
  const presetBtns  = [...document.querySelectorAll('.hzBtn')];
  const volBtns     = [...document.querySelectorAll('.volBtn')];
  const freezeBtn   = document.getElementById('freezeBtn');
  const saveBtn     = document.getElementById('saveBtn');
  const statusLine  = document.getElementById('statusLine');

  // çŠ¶æ…‹
  let currentHz = null;
  let currentVolPct = 0;

  // dBFSè¡¨ç¤ºï¼ˆRMSå¹³æ»‘ï¼‰
  const smoothAlpha = 0.2; // Î±=0.2
  let smoothedDb = null;

  // åˆæœŸåŒ–ï¼ˆå¿…è¦æ™‚ã«ä½œæˆï¼‰
  function ensureCtx(){
    if (!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      outGain  = audioCtx.createGain();
      outGain.gain.value = 0.0; // åˆæœŸã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
      master = audioCtx.createGain();
      master.gain.value = 1.0;

      outGain.connect(master).connect(audioCtx.destination);
    }
  }

  // ==========
  // ç™ºæŒ¯å™¨ï¼ˆæ­£å¼¦æ³¢ï¼‰
  // ==========
  function ensureOsc(){
    ensureCtx();
    if (!osc){
      osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(currentHz || 440, audioCtx.currentTime);
      osc.connect(outGain);
      osc.start();
    }
  }
  function startTone(){
    ensureCtx();
    ensureOsc();
  }
  function stopTone(){
    if (osc){
      try{ osc.disconnect(); }catch(e){}
      osc = null;
    }
  }
  function setFrequency(hz){
    currentHz = hz;
    freqLabel.textContent = `å‘¨æ³¢æ•°: ${hz.toFixed(2)} Hz`;
    if (osc && audioCtx){
      osc.frequency.setValueAtTime(hz, audioCtx.currentTime);
    }
  }
  function setVolumePct(pct){
    currentVolPct = Math.max(0, Math.min(100, pct|0));
    volLabel.textContent = `å‡ºåŠ›: ${currentVolPct}%`;
    if (outGain){
      // å‡ºåŠ›ï¼…ã¯ç·šå½¢ã§OKï¼ˆæ•™æç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ä»•æ§˜ï¼‰
      const v = currentVolPct/100;
      outGain.gain.setValueAtTime(v, audioCtx?.currentTime || 0);
    }
  }

  // ==========
  // ãƒã‚¤ã‚¯é–‹å§‹/åœæ­¢ & è§£æ
  // ==========
  async function startMic(){
    ensureCtx();
    if (!micStream){
      micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      micSrc = audioCtx.createMediaStreamSource(micStream);

      // HPF 5Hz ã§DC/ä½åŸŸãƒã‚¤ã‚ºé™¤å»
      hpf = audioCtx.createBiquadFilter();
      hpf.type = 'highpass';
      hpf.frequency.value = 5;

      // Analyserï¼ˆæ™‚é–“æ³¢å½¢å–å¾—ï¼‰
      analyser = audioCtx.createAnalyser();
      // 20msçª“ã«ãªã‚‹ã‚ˆã†fftSizeã‚’èª¿æ•´
      const targetSamples = Math.max(256, Math.round(audioCtx.sampleRate * 0.02)); // ç´„20ms
      const pow2 = (n)=>Math.pow(2, Math.round(Math.log2(n)));
      analyser.fftSize = Math.min(32768, Math.max(512, pow2(targetSamples*2)));
      analyser.smoothingTimeConstant = 0.0; // ç”Ÿãƒ‡ãƒ¼ã‚¿é‡è¦–

      micSrc.connect(hpf).connect(analyser);
    }
  }
  function stopMic(){
    if (analyser){ try{ hpf.disconnect(); }catch(e){} }
    analyser = null; hpf = null;
    if (micSrc){ try{ micSrc.disconnect(); }catch(e){} micSrc = null; }
    if (micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
  }

  // ==========
  // dBFS è¨ˆç®—ï¼ˆRMSâ†’20log10ï¼‰
  // ==========
  function calcDbfsFromTimeData(buf){
    // buf: -1.0..1.0
    let sum = 0;
    for (let i=0;i<buf.length;i++){
      const v = buf[i];
      sum += v*v;
    }
    const rms = Math.sqrt(sum / buf.length) || 0;
    const db = 20*Math.log10(rms + 1e-12); // 0ä»˜è¿‘ã¯ -âˆ å›é¿
    return db;
  }

  // ==========
  // æç”»
  // ==========
  function resizeCanvasForDPR(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx2d.setTransform(dpr,0,0,dpr,0,0); // CSSãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã§æã
  }

  function drawGrid(){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    ctx2d.clearRect(0,0,w,h);

    // èƒŒæ™¯
    ctx2d.fillStyle = '#fff';
    ctx2d.fillRect(0,0,w,h);

    // ã‚°ãƒªãƒƒãƒ‰
    ctx2d.strokeStyle = 'var(--grid)';
    ctx2d.lineWidth = 1;
    const divs = 10;
    // ç¸¦ç·šï¼ˆæ™‚é–“è»¸ 2ms/divï¼‰
    for (let i=0;i<=divs;i++){
      const x = (w/divs)*i;
      ctx2d.beginPath();
      ctx2d.moveTo(x, 0);
      ctx2d.lineTo(x, h);
      ctx2d.stroke();
    }
    // æ¨ªç·šï¼ˆæŒ¯å¹…ç›®å®‰ï¼‰
    for (let j=0;j<=divs;j++){
      const y = (h/divs)*j;
      ctx2d.beginPath();
      ctx2d.moveTo(0, y);
      ctx2d.lineTo(w, y);
      ctx2d.stroke();
    }

    // ä¸­å¤®ç·šï¼ˆã‚„ã‚„ä¸Šã«ï¼‰
    const centerY = Math.round(h*0.48); // å°‘ã—ä¸Šã«
    ctx2d.strokeStyle = 'var(--axis)';
    ctx2d.beginPath();
    ctx2d.moveTo(0, centerY + 0.5);
    ctx2d.lineTo(w, centerY + 0.5);
    ctx2d.stroke();

    // è»¸ãƒ©ãƒ™ãƒ«
    ctx2d.fillStyle = 'var(--muted)';
    ctx2d.font = '12px system-ui, sans-serif';
    ctx2d.fillText('æ™‚é–“ 2 ms/divï¼ˆ~20 msçª“ï¼‰', 8, 14);
    ctx2d.fillText('æŒ¯å¹…', 8, h-6);
  }

  function drawWave(timeData){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const centerY = Math.round(h*0.48);

    ctx2d.strokeStyle = 'var(--wave)';
    ctx2d.lineWidth = 2;
    ctx2d.beginPath();

    const len = timeData.length;
    for (let i=0;i<len;i++){
      const t = i / (len-1);
      const x = t * w;
      // -1..1 â†’ ãƒ”ã‚¯ã‚»ãƒ«
      const v = timeData[i];
      const y = centerY - v * (h*0.40); // å›ºå®šã‚¹ã‚±ãƒ¼ãƒ«
      if (i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    }
    ctx2d.stroke();
  }

  function render(){
    if (!frozen){
      resizeCanvasForDPR();
      drawGrid();

      if (analyser){
        const N = analyser.fftSize/2|0;
        const buf = new Float32Array(N);
        analyser.getFloatTimeDomainData(buf);

        // dBFSï¼ˆå¹³æ»‘ï¼‰
        const instDb = calcDbfsFromTimeData(buf);
        smoothedDb = (smoothedDb==null) ? instDb
                     : smoothAlpha*instDb + (1-smoothAlpha)*smoothedDb;
        statusLine.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šæ™‚é–“è»¸=2 ms/div å›ºå®šã€€|ã€€ãƒã‚¤ã‚¯éŸ³é‡ dBFS: ${smoothedDb.toFixed(1)} dB`;

        // æ³¢å½¢æç”»
        drawWave(buf);
      }
    }
    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  // ==========
  // äº‹ä»¶æŸã­
  // ==========
  // ãƒ—ãƒªã‚»ãƒƒãƒˆå‘¨æ³¢æ•°ãƒœã‚¿ãƒ³
  presetBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const hz = Number(btn.dataset.hz);
      if (!isNaN(hz)) setFrequency(hz);
      // ç™ºæŒ¯ä¸­ãªã‚‰å³æ™‚åæ˜ ã•ã‚Œã‚‹
    });
  });

  // éŸ³é‡ãƒœã‚¿ãƒ³
  volBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const pct = Number(btn.dataset.pct);
      if (!isNaN(pct)) setVolumePct(pct);
    });
  });

  // ãƒã‚¤ã‚¯
  micStartBtn.addEventListener('click', async ()=>{
    try{
      await startMic();
    }catch(err){
      alert('ãƒã‚¤ã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™ã‚„HTTPSã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      console.error(err);
    }
  });
  micStopBtn.addEventListener('click', ()=>{
    stopMic();
  });

  // ç™ºæŒ¯å™¨
  toneStartBtn.addEventListener('click', ()=>{
    startTone();
  });
  toneStopBtn.addEventListener('click', ()=>{
    stopTone();
  });

  // ãƒ•ãƒªãƒ¼ã‚ºï¼†ä¿å­˜
  freezeBtn.addEventListener('click', ()=>{
    frozen = !frozen;
    freezeBtn.textContent = frozen ? 'â–¶ å†é–‹' : 'â¸ åœæ­¢';
  });
  saveBtn.addEventListener('click', ()=>{
    // ç”»é¢ã®CSSã‚µã‚¤ã‚ºã§PNGåŒ–
    const tmp = document.createElement('canvas');
    tmp.width  = canvas.clientWidth;
    tmp.height = canvas.clientHeight;
    const tctx = tmp.getContext('2d');
    // DPRã‚’åæ˜ ã—ãŸç¾ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’CSSè§£åƒåº¦ã«æãæˆ»ã—
    tctx.drawImage(canvas, 0,0, tmp.width, tmp.height);
    const url = tmp.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.download = `scope_${ts}.png`;
    a.click();
  });

  // ã‚­ãƒ¼
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space'){
      e.preventDefault();
      frozen = !frozen;
      freezeBtn.textContent = frozen ? 'â–¶ å†é–‹' : 'â¸ åœæ­¢';
    }else if (e.key.toLowerCase() === 's'){
      e.preventDefault();
      saveBtn.click();
    }
  });

  // åˆæœŸè¡¨ç¤º
  setFrequency(440.00); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆA4
  setVolumePct(0);      // åˆæœŸã¯ç„¡éŸ³
})();
</script>
</body>
</html>

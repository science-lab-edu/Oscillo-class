<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>かんたんWebオシロスコープ（4画面比較版）</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
<style>
  :root{
    --ink:#0d2b66; --grid:#cfe2ff; --axis:#5b8bd9; --wave:#0066cc;
    --bg:#ffffff; --panel:#f5f9ff; --muted:#5f6b7a; --accent:#3b82f6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink)}
  header{padding:10px 16px;border-bottom:1px solid #e6eefc;background:#fff;position:sticky;top:0;z-index:2}
  header h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .panel{background:var(--panel);border:1px solid #e6eefc;border-radius:14px;padding:12px;box-shadow:0 1px 0 rgba(13,43,102,.04)}
  .controls{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.controls{grid-template-columns: 1.1fr 1fr}}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .preset{display:grid;grid-template-columns:repeat(8,minmax(56px,1fr));gap:8px}
  button{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
  button:focus{outline:2px solid #9cc4ff;outline-offset:2px}
  .note{height:44px}
  .note[data-n="ド"]{background:#fde68a}
  .note[data-n="レ"]{background:#fca5a5}
  .note[data-n="ミ"]{background:#fdba74}
  .note[data-n="ファ"]{background:#86efac}
  .note[data-n="ソ"]{background:#93c5fd}
  .note[data-n="ラ"]{background:#c4b5fd}
  .note[data-n="シ"]{background:#f0abfc}
  .note[data-n="ド↑"]{background:#a5f3fc}
  .tiny{font-size:12px;color:var(--muted)}
  .labeled{display:flex;align-items:center;gap:10px}
  .value-badge{min-width:62px;text-align:right;font-variant-numeric:tabular-nums}
  .value-badge strong{font-size:18px}
  .toggle{background:#fff;border:1px solid #d6e3ff}
  .toggle.on{background:#e0ecff}
  .toggle.small{padding:6px 10px;font-size:12px}
  .scopes-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr)); /* 常に2×2 */
    gap:10px;
  }
  .scopeBox{
    background:#fff;
    border-radius:12px;
    border:1px solid #e6eefc;
    padding:8px;
  }
  .scopeBox-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
  }
  .scopeLabel{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
  }
  .scopeMeta{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .scopeDb{
    font-size:20px;           /* ★デシベル表示を大きく */
    font-weight:700;          /* ★太字で強調 */
    color:var(--ink);         /* ★濃い色で目立たせる */
    font-variant-numeric:tabular-nums;
    min-width:72px;
    text-align:right;
  }
  canvas.scopeCanvas{
    width:100%;
    height:160px;
    background:#fff;
    border:1px solid #e6eefc;
    border-radius:10px;
    display:block;
  }
  footer{padding:10px 16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header><h1>かんたんWebオシロスコープ（4画面比較版）</h1></header>

<div class="wrap">
  <!-- 共通コントロール -->
  <div class="controls panel">
    <!-- プリセット -->
    <div class="row" aria-label="プリセット音">
      <div class="preset" id="presetArea">
        <button class="note" data-n="ド"  data-f="349.228">ド</button>
        <button class="note" data-n="レ"  data-f="392.000">レ</button>
        <button class="note" data-n="ミ"  data-f="440.000">ミ</button>
        <button class="note" data-n="ファ" data-f="466.164">ファ</button>
        <button class="note" data-n="ソ"  data-f="523.251">ソ</button>
        <button class="note" data-n="ラ"  data-f="587.330">ラ</button>
        <button class="note" data-n="シ"  data-f="659.255">シ</button>
        <button class="note" data-n="ド↑" data-f="698.456">ド</button>
      </div>
    </div>

    <!-- 音量（発信器 出力％） -->
    <div class="row labeled" aria-label="音量">
      <label for="vol"><strong>音量</strong></label>
      <input id="vol" type="range" min="0" max="100" step="1" value="20" style="flex:1">
      <div class="value-badge"><strong id="volPct">20</strong>%</div>
      <span class="tiny">※発信器の出力値</span>
    </div>

    <!-- コントロール群：全体停止/音停止/マイク停止 -->
    <div class="row" style="gap:10px">
      <button id="freezeBtn" class="toggle" aria-pressed="false">全体停止</button>
      <button id="toneStopBtn" class="toggle">音の発信停止</button>
      <button id="micToggleBtn" class="toggle" aria-pressed="true">マイク停止</button>
      <span class="tiny">※全体停止で音も全スコープの更新も止まります</span>
    </div>
  </div>

  <!-- 4つの波形表示（2×2）＋ 各グラフごとのdB表示 -->
  <div class="panel" style="margin-top:12px">
    <div class="scopes-grid">
      <div class="scopeBox" data-index="0">
        <div class="scopeBox-header">
          <div class="scopeLabel">小さい音</div>
          <div class="scopeMeta">
            <span class="scopeDb">--.- dB</span>
            <button class="toggle small holdBtn">波形固定</button>
          </div>
        </div>
        <canvas class="scopeCanvas" width="600" height="200" aria-label="小さい音のスコープ"></canvas>
      </div>
      <div class="scopeBox" data-index="1">
        <div class="scopeBox-header">
          <div class="scopeLabel">大きい音</div>
          <div class="scopeMeta">
            <span class="scopeDb">--.- dB</span>
            <button class="toggle small holdBtn">波形固定</button>
          </div>
        </div>
        <canvas class="scopeCanvas" width="600" height="200" aria-label="大きい音のスコープ"></canvas>
      </div>
      <div class="scopeBox" data-index="2">
        <div class="scopeBox-header">
          <div class="scopeLabel">低い音</div>
          <div class="scopeMeta">
            <span class="scopeDb">--.- dB</span>
            <button class="toggle small holdBtn">波形固定</button>
          </div>
        </div>
        <canvas class="scopeCanvas" width="600" height="200" aria-label="低い音のスコープ"></canvas>
      </div>
      <div class="scopeBox" data-index="3">
        <div class="scopeBox-header">
          <div class="scopeLabel">高い音</div>
          <div class="scopeMeta">
            <span class="scopeDb">--.- dB</span>
            <button class="toggle small holdBtn">波形固定</button>
          </div>
        </div>
        <canvas class="scopeCanvas" width="600" height="200" aria-label="高い音のスコープ"></canvas>
      </div>
    </div>
    <div class="tiny" style="margin-top:6px">
      各スコープの「波形固定」で、その瞬間の波形とdB値を残せます。<br>
      例：小さい音 → 大きい音 → 低い音 → 高い音の順に固定して比較。
    </div>
  </div>
</div>

<footer class="wrap">
  <div>© 教材用シンプル版 — ドレミボタン／音量％／全体停止＝音も停止／4画面比較／各スコープdB表示／周波数補正適用</div>
</footer>

<script>
(() => {
  // ====== Audio 基本 ======
  const AC = window.AudioContext || window.webkitAudioContext;
  const audio = new AC({latencyHint:'interactive'});

  let osc = null;
  const tonePreGain = audio.createGain(); // 周波数補正用
  tonePreGain.gain.value = 1.0;

  const outGain = audio.createGain();     // ユーザー音量（％）
  outGain.gain.value = 0.20;              // 初期20%
  tonePreGain.connect(outGain).connect(audio.destination);

  // ====== マイク ======
  const anaMic = audio.createAnalyser();
  anaMic.fftSize = 2048;
  anaMic.smoothingTimeConstant = 0.10;
  const timeMic = new Uint8Array(anaMic.fftSize);

  let micReady = false;
  let micStreamNode = null;
  let micStream = null;

  async function startMic(){
    if(micReady) return;
    try{
      micStream = await navigator.mediaDevices.getUserMedia({
        audio:{
          echoCancellation:false, noiseSuppression:false, autoGainControl:false,
          channelCount:1, sampleRate: audio.sampleRate
        }
      });
      micStreamNode = audio.createMediaStreamSource(micStream);
      micStreamNode.connect(anaMic);
      micReady = true;
      micToggleBtn.classList.add('on');
      micToggleBtn.setAttribute('aria-pressed','true');
      micToggleBtn.textContent = 'マイク停止';
    }catch(e){
      alert('マイクの許可が必要です。ブラウザの許可設定をご確認ください。');
    }
  }
  function stopMic(){
    try{ micStreamNode && micStreamNode.disconnect(); }catch{}
    if(micStream){ micStream.getTracks().forEach(t=>t.stop()); }
    micStreamNode = null; micStream = null; micReady = false;
    micToggleBtn.classList.remove('on');
    micToggleBtn.setAttribute('aria-pressed','false');
    micToggleBtn.textContent = 'マイク開始';
  }

  // ====== UI 要素 ======
  const vol = document.getElementById('vol');
  const volPct = document.getElementById('volPct');
  const freezeBtn = document.getElementById('freezeBtn');
  const toneStopBtn = document.getElementById('toneStopBtn');
  const micToggleBtn = document.getElementById('micToggleBtn');

  const canvases = Array.from(document.querySelectorAll('.scopeCanvas'));
  const ctxs = canvases.map(c => c.getContext('2d'));
  const holdBtns = Array.from(document.querySelectorAll('.holdBtn'));
  const dbSpans = Array.from(document.querySelectorAll('.scopeDb'));
  const holdFlags = [false,false,false,false];
  const heldDb = [null,null,null,null]; // 固定時のdB値を保存

  // ====== 縦レンジ：固定（×8 相当） ======
  const visGain = 8;

  function setVolumeFromSlider(){
    const pct = Number(vol.value)/100;
    outGain.gain.setValueAtTime(pct, audio.currentTime);
    volPct.textContent = Math.round(Number(vol.value));
  }
  vol.addEventListener('input', setVolumeFromSlider);

  // ====== 周波数補正（常時ON） ======
  const compByNote = {
    "ド": 1.728,
    "レ": 1.454,
    "ミ": 1.830,
    "ファ":1.155,
    "ソ": 0.649,
    "ラ": 0.917,
    "シ": 0.649,
    "ド↑":0.487
  };
  let currentNoteName = null;

  function startOsc(freq, noteName){
    stopOsc();
    osc = audio.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, audio.currentTime);
    osc.connect(tonePreGain);
    applyToneComp(noteName);
    osc.start();
  }
  function stopOsc(){
    if(osc){
      try{ osc.stop(); }catch{}
      try{ osc.disconnect(); }catch{}
      osc = null;
    }
  }
  function applyToneComp(noteName){
    currentNoteName = noteName || currentNoteName;
    const comp = (currentNoteName && compByNote[currentNoteName]) ? compByNote[currentNoteName] : 1.0;
    tonePreGain.gain.setValueAtTime(comp, audio.currentTime);
  }

  // プリセット押下で再生＆マイク起動
  document.getElementById('presetArea').addEventListener('click', async (e)=>{
    const btn = e.target.closest('.note'); if(!btn) return;
    if(audio.state !== 'running'){ try{ await audio.resume(); }catch{} }
    await startMic();
    const f = Number(btn.dataset.f);
    const name = btn.dataset.n;
    startOsc(f, name);
  });

  // ====== 全体停止（音も止める） ======
  let freeze = false;
  freezeBtn.addEventListener('click', ()=>{
    freeze = !freeze;
    freezeBtn.classList.toggle('on', freeze);
    freezeBtn.setAttribute('aria-pressed', String(freeze));
    freezeBtn.textContent = freeze ? '全体停止（停止中：音も停止）' : '全体停止';
    if(freeze){
      stopOsc();
    }else{
      drawOnce(true);
    }
  });

  // 個別ボタン：音の発信停止／マイク停止・開始
  toneStopBtn.addEventListener('click', ()=> stopOsc());
  micToggleBtn.addEventListener('click', async ()=>{
    const on = micToggleBtn.classList.contains('on');
    if(on){ stopMic(); } else { await startMic(); }
  });

  // 各スコープの「波形固定」トグル（波形 + dB を固定）
  holdBtns.forEach((btn, idx)=>{
    btn.addEventListener('click', ()=>{
      holdFlags[idx] = !holdFlags[idx];
      btn.classList.toggle('on', holdFlags[idx]);
      btn.textContent = holdFlags[idx] ? '固定中' : '波形固定';
      if(holdFlags[idx] && latestDbPos != null){
        heldDb[idx] = latestDbPos;
        dbSpans[idx].textContent = heldDb[idx].toFixed(1) + ' dB';
      }
    });
  });

  // ====== 描画 ======
  function drawGrid(ctx, w, h){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
    ctx.lineWidth = 1; ctx.beginPath();
    const gy = 4, gx = 8;
    for(let i=1;i<gy;i++){ const y = Math.round(h*i/gy)+0.5; ctx.moveTo(0,y); ctx.lineTo(w,y); }
    for(let i=1;i<gx;i++){ const x = Math.round(w*i/gx)+0.5; ctx.moveTo(x,0); ctx.lineTo(x,h); }
    ctx.stroke();
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--axis');
    ctx.beginPath(); ctx.moveTo(0,h/2+0.5); ctx.lineTo(w,h/2+0.5); ctx.stroke();
  }

  function drawWaveOn(ctx, canvas){
    const W = canvas.width, H = canvas.height;
    const buf = timeMic;
    const step = Math.ceil(buf.length / W);
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--wave');
    ctx.lineWidth = 2; ctx.beginPath();
    for(let x=0,i=0; x<W; x++, i+=step){
      const v = (buf[i]-128)/128;
      const y = H/2 - v * (H*0.45*visGain);
      const yy = Math.max(1, Math.min(H-1, y));
      if(x===0) ctx.moveTo(0,yy); else ctx.lineTo(x,yy);
    }
    ctx.stroke();
  }

  let dbSmooth = null;
  let latestDbPos = null;

  function calcDbFSAndUpdateLabels(){
    if(!micReady){
      dbSmooth = null;
      latestDbPos = null;
      dbSpans.forEach(span=> span.textContent = '--.- dB');
      return;
    }
    const fbuf = new Float32Array(anaMic.fftSize);
    anaMic.getFloatTimeDomainData(fbuf);
    let sum=0; for(let i=0;i<fbuf.length;i++){ const v=fbuf[i]; sum += v*v; }
    const rms = Math.sqrt(sum / fbuf.length) || 0;
    let db = 20 * Math.log10(rms);
    if(!isFinite(db)) db = -90;
    db = Math.max(db, -90);
    dbSmooth = (dbSmooth==null) ? db : (dbSmooth*0.8 + db*0.2);
    latestDbPos = Math.max(0, -dbSmooth);  // ★負値を正の「大きさ」に

    dbSpans.forEach((span, idx)=>{
      if(holdFlags[idx]){
        if(heldDb[idx] != null){
          span.textContent = heldDb[idx].toFixed(1) + ' dB';
        }else{
          span.textContent = '--.- dB';
        }
      }else{
        span.textContent = latestDbPos.toFixed(1) + ' dB';
      }
    });
  }

  function drawOnce(force=false){
    if(freeze && !force) return;

    if(micReady){
      anaMic.getByteTimeDomainData(timeMic);
    }

    ctxs.forEach((ctx, idx)=>{
      const canvas = canvases[idx];
      const W = canvas.width, H = canvas.height;
      if(!micReady){
        drawGrid(ctx,W,H);
        ctx.fillStyle = '#999';
        ctx.fillText('マイク未許可：プリセットを押すか、マイク開始を押してください', 10, 20);
        return;
      }
      if(holdFlags[idx]) return;
      drawGrid(ctx,W,H);
      drawWaveOn(ctx, canvas);
    });

    calcDbFSAndUpdateLabels();
  }
  (function loop(){ drawOnce(); requestAnimationFrame(loop); })();

  // ====== 初期化 ======
  setVolumeFromSlider();
})();
</script>
</body>
</html>
